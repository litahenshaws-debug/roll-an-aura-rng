<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roll an Aura Incremental</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            font-family: 'Verdana', sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            user-select: none;
        }

        h1 {
            font-family: 'Comic Sans MS', cursive;
            text-shadow: 4px 4px 0px #ff00ff;
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Status Area */
        #status-area {
            margin: 10px auto 20px;
            max-width: 600px;
            padding: 10px;
            border: 2px solid #555;
            border-radius: 8px;
            background: #282828;
            display: flex;
            justify-content: space-around;
            font-size: 1.1rem;
        }

        .luck-boost {
            color: #ffcc00;
            font-weight: bold;
        }

        .x10-boost {
            color: #00ffff;
        }

        .x100-boost {
            color: #ff00ff;
        }

        /* The Main Display Area */
        #display-area {
            border: 4px solid white;
            border-radius: 15px;
            background: #333;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            max-width: 600px;
            transition: all 0.2s;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        #aura-name {
            font-size: 2.5rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        #aura-rarity {
            font-size: 1.2rem;
            margin-top: 10px;
            font-style: italic;
        }

        /* Rolling Buttons */
        .btn {
            border: none;
            padding: 20px 50px;
            font-size: 2rem;
            color: white;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            font-family: 'Impact', sans-serif;
            margin: 5px;
        }

        #roll-btn {
            background: linear-gradient(45deg, #ff0000, #ff8800);
            box-shadow: 0 8px 0 #880000;
        }

        #roll-btn:active {
            transform: translateY(8px);
            box-shadow: 0 0 0 #880000;
        }

        #auto-roll-btn {
            background: linear-gradient(45deg, #00ffff, #0088ff);
            box-shadow: 0 8px 0 #0055aa;
            color: black;
        }

        #auto-roll-btn:active {
            transform: translateY(8px);
            box-shadow: 0 0 0 #0055aa;
        }

        #roll-btn:disabled,
        #auto-roll-btn:disabled {
            background: gray !important;
            box-shadow: 0 8px 0 #333 !important;
            cursor: not-allowed !important;
        }
        
        /* --- TAB UI STYLES --- */
        #tabs-container {
            max-width: 800px;
            margin: 30px auto 0px; 
            border-bottom: 2px solid #555;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; 
        }

        .tab-button {
            background: #444;
            color: white;
            border: 2px solid #555;
            border-bottom: none;
            padding: 10px 20px;
            margin: 0 2px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            transition: background 0.1s;
            margin-bottom: -2px; 
        }

        .tab-button:hover {
            background: #555;
        }

        .tab-button.active {
            background: #333;
            color: #ffcc00;
            border-color: #ffcc00;
            border-bottom: 2px solid #333; 
        }
        
        .tab-content {
            background: #333;
            border: 2px solid #555;
            border-radius: 0 0 10px 10px;
            padding: 20px 10px;
            max-width: 800px;
            margin: 0 auto;
            display: none;
            margin-bottom: 20px; 
        }

        .tab-content.active {
            display: block;
        }
        
        /* Shop & Checklist/Inventory Styles */
        #speed-shop h2, #luck-shop h2, #power-shop h2, #loot-shop h2, #checklist-tab h2, #inventory-tab h2 {
            margin-top: 0;
            color: #ffcc00;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }

        /* Luck Shop Content Styles */
        .boost-btn {
            box-shadow: 0 8px 0;
            font-size: 1.2rem;
            padding: 15px 25px;
            color: black;
            margin: 10px;
            display: inline-block;
            line-height: 1.2;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .boost-btn:active {
            transform: translateY(8px);
            box-shadow: 0 0 0;
        }

        #boost-5x {
            background: linear-gradient(45deg, #ffcc00, #ffa300);
            box-shadow: 0 8px 0 #cc8800;
        }

        #boost-10x {
            background: linear-gradient(45deg, #00ffff, #00ff88);
            box-shadow: 0 8px 0 #008855;
        }

        #boost-100x {
            background: linear-gradient(45deg, #ff00ff, #aa00ff);
            box-shadow: 0 8px 0 #880088;
        }
        
        #mystery-btn {
            background: linear-gradient(45deg, #ff9900, #ff0066);
            box-shadow: 0 8px 0 #995c00;
            color: white;
            font-size: 1.2rem;
        }

        /* Shard Button Styles */
        .shard-btn {
            background: linear-gradient(45deg, #00ccff, #0066ff);
            box-shadow: 0 8px 0 #005c99;
            color: white;
            font-size: 1.1rem;
            padding: 12px 20px;
            margin: 5px;
            display: inline-block;
            line-height: 1.2;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .shard-btn:active {
            transform: translateY(8px);
            box-shadow: 0 0 0;
        }


        .disabled-boost {
            background: gray !important;
            box-shadow: 0 8px 0 #333 !important;
            cursor: not-allowed !important;
        }

        .active-boost {
            background: #ff4500 !important;
            box-shadow: 0 8px 0 #992a00 !important;
            color: white !important;
        }
        
        .upgrade-btn {
            background: linear-gradient(45deg, #0088ff, #0044aa);
            box-shadow: 0 6px 0 #002255;
            color: white;
            font-size: 1.1rem;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.1s;
            line-height: 1.2;
        }

        .upgrade-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #002255;
        }

        .upgrade-btn:disabled {
            background: gray !important;
            box-shadow: 0 6px 0 #333 !important;
            cursor: not-allowed !important;
        }

        .purchased-upgrade {
            background: linear-gradient(45deg, #00cc00, #009900) !important;
            box-shadow: 0 6px 0 #005500 !important;
            cursor: not-allowed !important;
        }

        #rebirth-btn {
            background: linear-gradient(45deg, #ff4500, #cc0000);
            box-shadow: 0 8px 0 #992a00;
            color: white;
            font-size: 1.5rem;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s;
            margin-top: 10px;
        }

        #rebirth-btn:active {
            transform: translateY(8px);
            box-shadow: 0 0 0 #992a00;
        }

        #rebirth-btn:disabled {
            background: #555 !important;
            box-shadow: 0 8px 0 #333 !important;
            cursor: not-allowed !important;
        }
        
        /* --- RARITY COLORS --- */
        .common {
            color: #ffffff;
            text-shadow: 0 0 5px #ffffff;
        }

        .uncommon {
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }
        
        .uncommon-shade {
            color: #008800; 
        }

        .rare {
            color: #0088ff;
            text-shadow: 0 0 10px #0088ff;
        }
        
        .rare-shade {
            color: #004488;
        }

        .epic {
            color: #aa00ff;
            text-shadow: 0 0 15px #aa00ff;
        }
        
        .epic-shade {
            color: #550088;
        }

        .legendary {
            color: #ffaa00;
            text-shadow: 0 0 20px #ffaa00;
            animation: shake 0.5s infinite;
        }
        
        .legendary-shade {
            color: #aa5500;
        }

        .mythical {
            background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
            -webkit-background-clip: text;
            color: transparent;
            font-size: 3rem !important;
            animation: rainbow-spin 2s linear infinite;
        }
        
        .mythical-shade {
            color: #cc00cc;
        }

        .divine {
            color: #ff00aa;
            text-shadow: 0 0 25px #ff00aa;
            animation: pulse 1.5s infinite alternate;
        }
        
        .divine-shade {
            color: #990066;
        }

        .cosmic {
            color: #9933ff;
            text-shadow: 0 0 30px #9933ff, 0 0 50px #9933ff;
            font-size: 3.5rem !important;
            animation: cosmic-wave 3s linear infinite;
        }
        
        .cosmic-shade {
            color: #5c1f99;
        }

        /* Checklist Styles (In Checklist Tab) */
        .checklist {
            padding-top: 10px;
        }

        #uncollected-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 800px;
            margin: 10px auto;
            font-size: 0.9rem;
        }

        .uncollected-item {
            background: #222;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px dashed #555;
            opacity: 0.5;
            text-decoration: line-through;
        }

        .collected-item {
            opacity: 1 !important;
            border: 1px solid #ffcc00 !important;
            text-decoration: none !important;
        }

        /* Inventory Styles (In Inventory Tab) */
        .inventory {
            padding-top: 10px;
        }

        .item-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .inv-item {
            background: #222;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            width: 120px;
            font-size: 0.8rem;
        }

        /* Sell Button Style */
        .inventory-btn {
            box-shadow: 0 5px 0;
            font-size: 1rem;
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.1s;
            margin: 5px;
        }

        .inventory-btn:active {
            transform: translateY(5px);
            box-shadow: 0 0 0;
        }

        #sell-all-btn {
            background: linear-gradient(45deg, #00aa00, #00cc00);
            box-shadow: 0 5px 0 #006600;
        }
        
        #auto-sell-btn {
            background: linear-gradient(45deg, #ffcc00, #ffaa00);
            box-shadow: 0 5px 0 #cc8800;
            color: black;
        }

        #auto-sell-btn.active-sell {
             background: linear-gradient(45deg, #ff4500, #cc0000);
             box-shadow: 0 5px 0 #992a00;
             color: white;
        }


        #reset-btn {
            margin-top: 30px;
            padding: 10px 20px;
            background: #cc0000;
            box-shadow: 0 5px 0 #770000;
            font-size: 1rem;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        #reset-btn:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 #770000;
        }
    </style>
</head>

<body>

    <audio id="throttle-preventer" loop muted>
        <source src="YOUR_BGM_FILE_URL_HERE" type="audio/mp3"> 
    </audio>

    <h1>‚≠ê Roll an Aura ‚≠ê</h1>
    <p>Total Auras: 23 (v2.9.9.1). **Button Fixed**.</p>

    <div id="status-area">
        <div>Current Luck: <span id="luck-display" class="luck-boost">1x</span></div>
        <div>üí∞ Coins: <span id="money-display" style="color: gold; font-weight: bold;">0</span></div>
        <div>‚ö° Power: <span id="power-display" style="color: red; font-weight: bold;">0</span></div>
        <div>üíé Shards: <span id="shard-display" style="color: #00ccff; font-weight: bold;">0</span></div>
        <div>Collected: <span id="collected-count">0/23</span></div>
    </div>

    <div id="display-area">
        <div id="aura-name">???</div>
        <div id="aura-rarity">Click button to steal</div>
    </div>
    
    <div id="limited-aura-status" style="margin: 20px auto; padding: 15px; border: 2px solid #9933ff; border-radius: 10px; background: #222; max-width: 600px;">
        <div id="limited-aura-display" style="font-size: 1.2rem; color: white;">
            Checking for Limited-Time Aura...
        </div>
    </div>
    <button id="roll-btn" class="btn" onclick="rollAura(false)">STEAL!</button>
    <button id="auto-roll-btn" class="btn" onclick="toggleAutoRoll()">AUTO ROLL</button>
    
    <div id="tabs-container">
        <button class="tab-button" onclick="openTab('luck-shop', this)" id="luck-tab">üí∞ Luck Boosts</button>
        <button class="tab-button" onclick="openTab('loot-shop', this)" id="loot-tab">üéÅ Coin Sink</button>
        <button class="tab-button" onclick="openTab('speed-shop', this)" id="speed-tab">‚ö° Speed Shop</button>
        <button class="tab-button" onclick="openTab('power-shop', this)" id="power-tab">üî• Power & Rebirth</button>
        <button class="tab-button" onclick="openTab('checklist-tab', this)" id="checklist-tab-btn">üìö Checklist</button>
        <button class="tab-button" onclick="openTab('inventory-tab', this)" id="inventory-tab-btn">üéí Inventory</button>
    </div>

    <div id="tab-content-container">
        
        <div id="luck-shop" class="tab-content active">
            <h2>üí∞ Luck Boosts (Temporary)</h2>
            <div id="boost-buttons">
                <button id="boost-5x" class="boost-btn" onclick="activateBoost(5)">5X LUCK<br>(Cost: üí∞1,000)</button>
                <button id="boost-10x" class="boost-btn" onclick="activateBoost(10)">10X LUCK<br>(Cost: üí∞5,000)</button>
                <button id="boost-100x" class="boost-btn" onclick="activateBoost(100)">100X LUCK<br>(Cost: üí∞50,000)</button>
            </div>
        </div>
        
        <div id="loot-shop" class="tab-content">
            <h2>üéÅ Coin Sink (Mystery Box)</h2>
            <p style="font-style: italic;">Spend coins for a guaranteed high-rarity Aura + bonus chance.</p>

            <button id="mystery-btn" class="boost-btn" onclick="openMysteryBox()">
                MYSTERY BOX<br>(Cost: üí∞50,000)
            </button>
        </div>


        <div id="speed-shop" class="tab-content">
            <h2>‚ö° AUTO ROLL SPEED SHOP <span id="speed-level-display">(Level 0)</span></h2>
            <div id="speed-upgrades">
                </div>
        </div>
        
        <div id="power-shop" class="tab-content">
            <h2>üî• REBIRTH POWER UPGRADES üî•</h2>
            
            <div style="border: 2px solid #ffcc00; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
                <p>Current Income Multiplier: <span id="income-mult-display" style="color: lime; font-weight: bold;">1.0x</span></p>
                <p id="rebirth-cost-display">Reach üí∞1,000,000 to Rebirth.</p>
                <button id="rebirth-btn" onclick="doRebirth()" disabled>REBIRTH NOW</button>
            </div>

            <hr style="border-color: #555; margin: 20px 0;">
            
            <h3>üíé Permanent Shard Upgrades (Survive Rebirth)</h3>
            
            <div id="shard-upgrades-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                
                <div style="border: 1px solid #0066ff; padding: 10px; border-radius: 8px;">
                    <button id="shard-mult-btn" class="shard-btn" onclick="buyShardUpgrade('shard-mult')">
                        Permanent Shard Multiplier<br>(Cost: üíé10 Shards)
                    </button>
                    <p id="shard-mult-status" style="margin-top: 5px; color: lime; font-size: 0.9rem;">Current Multiplier: 1x</p>
                </div>

                <div style="border: 1px solid #0066ff; padding: 10px; border-radius: 8px;">
                    <button id="rebirth-start-1-btn" class="shard-btn" onclick="buyShardUpgrade('rebirth-start-1')">
                        Pocket Change T1<br>(Cost: üíé25 Shards)
                    </button>
                    <p id="rebirth-start-1-status" style="margin-top: 5px; color: yellow; font-size: 0.9rem;">Status: Unpurchased (+üí∞2,500 on Rebirth)</p>
                    
                    <button id="rebirth-start-2-btn" class="shard-btn" onclick="buyShardUpgrade('rebirth-start-2')">
                        Pocket Change T2<br>(Cost: üíé75 Shards)
                    </button>
                    <p id="rebirth-start-2-status" style="margin-top: 5px; color: yellow; font-size: 0.9rem;">Status: Unpurchased (+üí∞10,000 on Rebirth)</p>
                </div>
                
                <div style="border: 1px solid #0066ff; padding: 10px; border-radius: 8px;">
                    <button id="rare-chance-btn" class="shard-btn" onclick="buyShardUpgrade('rare-chance')">
                        Sharp Senses<br>(Cost: üíé50 Shards)
                    </button>
                    <p id="rare-chance-status" style="margin-top: 5px; color: yellow; font-size: 0.9rem;">Bonus: 0.0x (Rare/Uncommon chance)</p>
                </div>

            </div>
        </div>
        
        <div id="checklist-tab" class="tab-content">
            <div class="checklist">
                <h2>üìã AURA CHECKLIST</h2>
                <div id="uncollected-list">
                    </div>
            </div>
        </div>
        
        <div id="inventory-tab" class="tab-content">
             <div class="inventory">
                <h2>üéí STOLEN COLLECTION (Latest First)</h2>
                
                <div style="margin-bottom: 10px;">
                    <button id="sell-all-btn" class="inventory-btn" onclick="sellAllItems()">SELL ALL ITEMS</button>
                    
                    <button id="auto-sell-btn" class="inventory-btn" onclick="toggleAutoSell()">
                        AUTO SELL: OFF
                    </button>
                </div>
                
                <div class="item-list" id="inventory-list">
                    </div>
            </div>
        </div>
        
    </div>
    <button id="reset-btn" onclick="resetGame()">üö® RESET GAME DATA üö®</button>

    <script>
        // Define currency and storage key globally
        let money = 0;
        let shards = 0;
        let shardMultiplier = 1;
        let rebirthStartMoney = 500; 
        let rebirthStartT1Purchased = false;
        let rebirthStartT2Purchased = false;
        let rareBonusLuck = 0; 
        
        let autoRollSpeed = 1000;
        let speedLevel = 0;
        let power = 0;
        let powerMultiplier = 1;
        const BASE_REBIRTH_COST = 1000000;
        const POWER_BONUS = 2;
        
        let isAutoSelling = false;

        // Storage keys updated for v2.9.9.1
        const VERSION_KEY = 'v2_9_9_1';
        const MONEY_STORAGE_KEY = `aura_money_${VERSION_KEY}`;
        const SHARDS_STORAGE_KEY = `aura_shards_${VERSION_KEY}`;
        const SHARD_MULT_STORAGE_KEY = `aura_shard_mult_${VERSION_KEY}`;
        const REBIRTH_START_T1_KEY = `aura_start_t1_purchased_${VERSION_KEY}`;
        const REBIRTH_START_T2_KEY = `aura_start_t2_purchased_${VERSION_KEY}`;
        const RARE_BONUS_KEY = `aura_rare_bonus_luck_${VERSION_KEY}`;
        const SPEED_STORAGE_KEY = `aura_speed_${VERSION_KEY}`;
        const POWER_STORAGE_KEY = `aura_power_${VERSION_KEY}`;
        const COLLECTION_STORAGE_KEY = `aura_collection_${VERSION_KEY}`;
        const INVENTORY_STORAGE_KEY = `aura_inventory_${VERSION_KEY}`;
        const LAST_SAVE_TIME_KEY = `aura_last_save_time_${VERSION_KEY}`;
        const AUTO_SELL_KEY = `aura_auto_sell_${VERSION_KEY}`;
        const LUCK_MULT_KEY = `aura_luck_mult_${VERSION_KEY}`;
        const ROLLS_LEFT_KEY = `aura_rolls_left_${VERSION_KEY}`;
        const COOLDOWNS_KEY = `aura_cooldowns_${VERSION_KEY}`;


        // --- CORE AURA LIST ---
        const auras = [
            // Commons
            { name: "NPC Energy", rarity: "Common", chance: 2, class: "common", value: 50, shardValue: 0 },
            { name: "Low Taper Fade", rarity: "Common", chance: 3, class: "common", value: 60, shardValue: 0 },
            // Uncommons
            { name: "Just a Chill Guy", rarity: "Uncommon", chance: 5, class: "uncommon", value: 75, shardValue: 0 },
            { name: "Bombastic Side Eye", rarity: "Uncommon", chance: 8, class: "uncommon", value: 100, shardValue: 0 },
            // Rares (START GIVING SHARDS)
            { name: "Grimace Shake", rarity: "Rare", chance: 15, class: "rare", value: 150, shardValue: 1 },
            { name: "Skibidi Toilet", rarity: "Rare", chance: 25, class: "rare", value: 250, shardValue: 1 },
            { name: "Gen Z Slang Master", rarity: "Rare", chance: 30, class: "rare", value: 300, shardValue: 1 },
            // Epics
            { name: "Fanum Tax", rarity: "Epic", chance: 50, class: "epic", value: 500, shardValue: 2 },
            { name: "6-7 BRAIN ROT", rarity: "Epic", chance: 80, class: "epic", value: 800, shardValue: 2 },
            { name: "Ohio Final Boss", rarity: "Epic", chance: 80, class: "epic", value: 900, shardValue: 2 },
            { name: "Rizz God", rarity: "Epic", chance: 100, class: "epic", value: 1200, shardValue: 2 },
            // Legendaries
            { name: "SIGMA GIGACHAD", rarity: "LEGENDARY", chance: 200, class: "legendary", value: 2500, shardValue: 5 },
            { name: "MAXIMUM RIZZLER", rarity: "LEGENDARY", chance: 500, class: "legendary", value: 5000, shardValue: 5 },
            { name: "BUSSIN' Aura", rarity: "LEGENDARY", chance: 600, class: "legendary", value: 7500, shardValue: 5 },
            // Mythicals
            { name: "‚ú® THE ONE PIECE ‚ú®", rarity: "MYTHICAL", chance: 1000, class: "mythical", value: 15000, shardValue: 10 },
            { name: "Infinite Brain Rot", rarity: "MYTHICAL", chance: 1200, class: "mythical", value: 20000, shardValue: 10 },
            // Divines
            { name: "Tung Tung Shar", rarity: "DIVINE", chance: 2500, class: "divine", value: 30000, shardValue: 20 },
            { name: "DeeMeeTree", rarity: "DIVINE", chance: 2500, class: "divine", value: 35000, shardValue: 20 },
            // Cosmics
            { name: "Sigma Chad", rarity: "COSMIC", chance: 5000, class: "cosmic", value: 50000, shardValue: 30 },
            { name: "Big Back", rarity: "COSMIC", chance: 5000, class: "cosmic", value: 75000, shardValue: 30 }
        ];

        // --- LIMITED TIME AURA (LTA) LIST ---
        // Seasons: Spring (Mar-May), Summer (Jun-Aug), Fall (Sep-Nov), Winter (Dec-Feb)
        const limitedAuras = [
            // Fall: Months 8, 9, 10 (Sept, Oct, Nov)
            { name: "Seasonal Spook", rarity: "MYTHICAL (LTD)", chance: 1500, class: "mythical", value: 30000, shardValue: 15, id: 1, season: 'Fall' }, 
            // Winter: Months 11, 0, 1 (Dec, Jan, Feb)
            { name: "Holiday Hype", rarity: "DIVINE (LTD)", chance: 3000, class: "divine", value: 50000, shardValue: 25, id: 2, season: 'Winter' }, 
            // Summer: Months 5, 6, 7 (Jun, Jul, Aug)
            { name: "Summer Chill", rarity: "COSMIC (LTD)", chance: 7500, class: "cosmic", value: 100000, shardValue: 40, id: 3, season: 'Summer' }
        ];

        let activeLimitedAura = null;

        const speedUpgrades = [
            { id: 1, cost: 10000, speed: 750, label: "Fast Roll (750ms)" },
            { id: 2, cost: 50000, speed: 500, label: "Turbo Roll (500ms)" },
            { id: 3, cost: 250000, speed: 250, label: "Max Speed (250ms)" }
        ];

        // GLOBAL STATE VARIABLES
        let isRolling = false;
        let autoRollInterval = null;
        let luckMultiplier = 1;
        let rollsLeft = 0;
        let cooldowns = {}; // Tracks time remaining for boost cooldowns
        let activeTabName = 'luck-shop'; 
        
        // Collection Tracking
        let collectedAuras = new Set();
        let inventory = []; 
        
        // Boost Button Definitions
        const boostButtons = [
            { id: 'boost-5x', mult: 5, cost: 1000, duration: 300, rolls: 10, name: '5X LUCK' },
            { id: 'boost-10x', mult: 10, cost: 5000, duration: 600, rolls: 5, name: '10X LUCK' },
            { id: 'boost-100x', mult: 100, cost: 50000, duration: 6000, rolls: 1, name: '100X LUCK' }
        ];

        // Store active cooldown interval timers
        let cooldownTimers = {};


        function getButton(id) {
            return document.getElementById(id);
        }
        
        // Helper to find the full aura object (including rarity/class) from name
        function getAuraDetails(name) {
            const allAuras = [...auras, ...limitedAuras];
            return allAuras.find(a => a.name === name);
        }

        // --- CURRENCY AND STATS ---
        function updateMoneyDisplay() {
            getButton('money-display').textContent = money.toLocaleString();
            getButton('shard-display').textContent = shards.toLocaleString();
            updateLuckDisplay(); 
            renderSpeedShop(); 
            updateRebirthDisplay(); 
            renderLootShop(); 
            renderPowerShop(); 
            updateAutoSellButton();
        }

        function loadStats() {
            money = parseInt(localStorage.getItem(MONEY_STORAGE_KEY) || 500);
            shards = parseInt(localStorage.getItem(SHARDS_STORAGE_KEY) || 0);
            shardMultiplier = parseInt(localStorage.getItem(SHARD_MULT_STORAGE_KEY) || 1);
            
            // SHARD UPGRADES LOADING
            rebirthStartT1Purchased = localStorage.getItem(REBIRTH_START_T1_KEY) === 'true';
            rebirthStartT2Purchased = localStorage.getItem(REBIRTH_START_T2_KEY) === 'true';
            rareBonusLuck = parseFloat(localStorage.getItem(RARE_BONUS_KEY) || 0);
            
            // AUTO-SELL LOADING
            isAutoSelling = localStorage.getItem(AUTO_SELL_KEY) === 'true';

            // Calculate starting money
            rebirthStartMoney = 500;
            if (rebirthStartT1Purchased) rebirthStartMoney = 2500;
            if (rebirthStartT2Purchased) rebirthStartMoney = 10000;
        }
        
        function saveStats() {
            localStorage.setItem(MONEY_STORAGE_KEY, money.toString());
            localStorage.setItem(SHARDS_STORAGE_KEY, shards.toString());
            localStorage.setItem(SHARD_MULT_STORAGE_KEY, shardMultiplier.toString());
            
            // SHARD UPGRADES SAVING
            localStorage.setItem(REBIRTH_START_T1_KEY, rebirthStartT1Purchased.toString());
            localStorage.setItem(REBIRTH_START_T2_KEY, rebirthStartT2Purchased.toString());
            localStorage.setItem(RARE_BONUS_KEY, rareBonusLuck.toString());
            
            // AUTO-SELL SAVING
            localStorage.setItem(AUTO_SELL_KEY, isAutoSelling.toString());
        }
        
        function loadPower() {
            power = parseInt(localStorage.getItem(POWER_STORAGE_KEY) || 0);
            calculatePowerMultiplier();
        }
        
        function savePower() {
            localStorage.setItem(POWER_STORAGE_KEY, power.toString());
        }

        function saveSpeed() {
            localStorage.setItem(SPEED_STORAGE_KEY, autoRollSpeed.toString());
        }
        
        function updateCollectedCount() {
            getButton('collected-count').textContent = `${collectedAuras.size}/${auras.length + limitedAuras.length}`;
        }
        
        function loadInventory() {
            const storedInventory = localStorage.getItem(INVENTORY_STORAGE_KEY);
            if (storedInventory) {
                try {
                    inventory = JSON.parse(storedInventory);
                } catch (e) {
                    inventory = [];
                }
            }
        }

        function saveInventory() {
            localStorage.setItem(INVENTORY_STORAGE_KEY, JSON.stringify(inventory));
        }

        // --- NEW BOOST STATE SAVING/LOADING ---
        function saveBoostState() {
            localStorage.setItem(LUCK_MULT_KEY, luckMultiplier.toString());
            localStorage.setItem(ROLLS_LEFT_KEY, rollsLeft.toString());
            
            // Save the time remaining for all cooldowns
            const savedCooldowns = {};
            boostButtons.forEach(b => {
                // Only save if a cooldown is active
                if (cooldowns[b.id] > 0) {
                    savedCooldowns[b.id] = cooldowns[b.id];
                }
            });
            localStorage.setItem(COOLDOWNS_KEY, JSON.stringify(savedCooldowns));
        }
        
        function loadBoostState() {
            luckMultiplier = parseFloat(localStorage.getItem(LUCK_MULT_KEY) || 1);
            rollsLeft = parseInt(localStorage.getItem(ROLLS_LEFT_KEY) || 0);

            // Load cooldowns
            const storedCooldownsJson = localStorage.getItem(COOLDOWNS_KEY);
            if (storedCooldownsJson) {
                try {
                    const storedCooldowns = JSON.parse(storedCooldownsJson);
                    
                    // Initialize or reset cooldowns array first
                    boostButtons.forEach(b => {
                        cooldowns[b.id] = storedCooldowns[b.id] || 0;
                    });
                    
                    // Re-start the timers for active cooldowns
                    boostButtons.forEach(b => {
                        if (cooldowns[b.id] > 0) {
                            startCooldown(b.id, cooldowns[b.id]);
                        }
                    });
                } catch (e) {
                    // Reset cooldowns if parsing failed
                     boostButtons.forEach(b => cooldowns[b.id] = 0);
                }
            } else {
                 boostButtons.forEach(b => cooldowns[b.id] = 0);
            }
            
            // If the multiplier is > 1 but rolls are 0 (e.g., bugged save), reset it
            if (luckMultiplier > 1 && rollsLeft <= 0) {
                luckMultiplier = 1;
            }
        }


        // --- Record Time on Exit ---
        window.addEventListener('beforeunload', () => {
            // Only record the time if the game has started
            if (money > 0) {
                localStorage.setItem(LAST_SAVE_TIME_KEY, Date.now().toString());
                // Ensure all current stats are saved
                saveStats(); 
                savePower();
                saveSpeed();
                saveCollection();
                saveInventory();
                saveBoostState(); 
            }
        });


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadSpeed(); 
            loadPower(); 
            loadCollection();
            loadInventory(); 
            loadBoostState(); 

            // Check for offline progress immediately
            checkOfflineProgress();

            determineActiveLimitedAura();
            updateLuckDisplay();
            renderChecklist();
            updateCollectedCount();
            renderInventory(); 
            renderSpeedShop(); 
            updateRebirthDisplay(); 
            updateMoneyDisplay();
            
            // Initial tab display: show the first tab by default
            openTab('luck-shop', getButton('luck-tab'));
        });
        
        // --- OFFLINE PROGRESS FUNCTION ---
        function checkOfflineProgress() {
            const lastTime = localStorage.getItem(LAST_SAVE_TIME_KEY);
            if (!lastTime) return; // No previous save time found

            const lastTimestamp = parseInt(lastTime);
            const currentTime = Date.now();
            const timeDifferenceMs = currentTime - lastTimestamp;
            
            // Do not reward if less than 5 seconds have passed
            if (timeDifferenceMs < 5000) return; 

            // Clear the stored time so we only reward it once
            localStorage.removeItem(LAST_SAVE_TIME_KEY);
            
            // Determine the time-per-roll
            const timePerRollMs = autoRollSpeed;

            // Cap the offline time (e.g., to 24 hours, or 86,400,000 ms)
            const OFFLINE_CAP_MS = 86400000; 
            
            // Calculate the maximum number of rolls that could have occurred within the cap
            const cappedRolls = Math.min(Math.floor(timeDifferenceMs / timePerRollMs), Math.floor(OFFLINE_CAP_MS / timePerRollMs));
            
            if (cappedRolls === 0) return;

            // --- SIMULATE ROLLS ---
            let totalRolls = cappedRolls;
            let totalCoinsGained = 0;
            let totalShardsGained = 0;
            
            // Determine the aura list for offline roll
            // IMPORTANT: We need to determine the active LTA based on the LAST SAVE TIME
            // This is complex, so for simplicity in offline mode, we assume LTAs are NOT active
            // OR we use the current determined LTA (which is simpler but less accurate)
            // Let's use the current determined LTA, as we cannot easily determine what day/month it was at the time of exit.
            determineActiveLimitedAura(); // Set LTA based on current time
            const currentAuraList = getAurasForRolling();
            
            // Sort by chance to properly simulate the roll logic
            const sortedAuras = [...currentAuraList].sort((a, b) => b.chance - a.chance);

            for (let i = 0; i < totalRolls; i++) {
                // Simulate a roll (always use 1x luck for offline, as boosts are temporary)
                
                let result = sortedAuras[0]; 
                const OFFLINE_LUCK_MULT = 1; 
                
                for (let aura of sortedAuras) {
                    let threshold = (1000 / aura.chance) * OFFLINE_LUCK_MULT;
                    
                     // Apply permanent rare bonus
                    if (aura.rarity === 'Uncommon' || aura.rarity === 'Rare') {
                        threshold += threshold * rareBonusLuck; 
                    }

                    if (Math.random() * 1000 <= threshold) {
                        result = aura;
                        break;
                    }
                }

                // Grant rewards (Offline Auras are always sold instantly)
                const coinGain = Math.floor(result.value * powerMultiplier);
                totalCoinsGained += coinGain;
                totalShardsGained += (result.shardValue * shardMultiplier);
                
                // Update collection
                saveAuraToCollection(result.name);
            }
            
            // --- APPLY TOTAL REWARDS ---
            money += totalCoinsGained;
            shards += totalShardsGained;
            
            // Final save after granting all offline progress
            saveStats(); 
            
            // --- DISPLAY POPUP ---
            const totalSeconds = Math.floor(timeDifferenceMs / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            
            const popupMessage = `
                Welcome back! You were away for ${hours}h ${minutes}m. (Capped at 24h)
                \nOffline Progress Granted (${totalRolls.toLocaleString()} rolls):
                \nüí∞ Coins Gained: ${totalCoinsGained.toLocaleString()}
                \nüíé Shards Gained: ${totalShardsGained.toLocaleString()}
                \n‚úÖ Auras Collected: ${totalRolls} (Auto-Sold)
            `;

            alert(popupMessage);
            
            // Refresh displays
            updateMoneyDisplay();
            updateCollectedCount();
        }
        // --- END OFFLINE PROGRESS FUNCTION ---


        // --- AUTO-SELL LOGIC ---
        function toggleAutoSell() {
            isAutoSelling = !isAutoSelling;
            saveStats();
            updateAutoSellButton();

            if (isAutoSelling) {
                // If turning ON auto-sell, immediately sell any existing inventory
                if (inventory.length > 0) {
                    sellAllItems();
                    alert("Auto-Sell activated. Existing inventory sold instantly.");
                }
            }
        }

        function updateAutoSellButton() {
            const autoSellBtn = getButton('auto-sell-btn');
            if (isAutoSelling) {
                autoSellBtn.textContent = "AUTO SELL: ON (Instant Money)";
                autoSellBtn.classList.add('active-sell');
            } else {
                autoSellBtn.textContent = "AUTO SELL: OFF (Save to Inventory)";
                autoSellBtn.classList.remove('active-sell');
            }
        }
        // --- END AUTO-SELL LOGIC ---


        // --- LOOT SHOP LOGIC (COIN SINK) ---
        function renderLootShop() {
            // Coin Sink (Mystery Box)
            const mysteryBtn = getButton('mystery-btn');
            const cost = 50000;

            if (money < cost) {
                mysteryBtn.disabled = true;
                mysteryBtn.classList.add('disabled-boost');
                mysteryBtn.innerHTML = `MYSTERY BOX<br>(Cost: üí∞${cost.toLocaleString()}) <span style="color:red;">(TOO POOR)</span>`;
            } else {
                mysteryBtn.disabled = false;
                mysteryBtn.classList.remove('disabled-boost');
                mysteryBtn.innerHTML = `MYSTERY BOX<br>(Cost: üí∞${cost.toLocaleString()})`;
            }
        }


        // --- POWER SHOP LOGIC (SHARD UPGRADES) ---
        function renderPowerShop() {
            // 1. Shard Multiplier
            const shardMultBtn = getButton('shard-mult-btn');
            const shardCost = 10 * shardMultiplier;
            getButton('shard-mult-status').textContent = `Current Multiplier: ${shardMultiplier}x`;
            shardMultBtn.innerHTML = `Permanent Shard Multiplier<br>(Cost: üíé${shardCost} Shards)`;
            shardMultBtn.disabled = shards < shardCost;
            shardMultBtn.classList.toggle('disabled-boost', shards < shardCost);


            // 2. Pocket Change T1
            const t1Btn = getButton('rebirth-start-1-btn');
            const t1Cost = 25;
            t1Btn.innerHTML = `Pocket Change T1<br>(Cost: üíé${t1Cost} Shards)`;
            getButton('rebirth-start-1-status').textContent = `Status: ${rebirthStartT1Purchased ? 'PURCHASED' : 'Unpurchased'} (+üí∞2,500 on Rebirth)`;
            t1Btn.disabled = rebirthStartT1Purchased || shards < t1Cost || rebirthStartT2Purchased;
            t1Btn.classList.toggle('purchased-upgrade', rebirthStartT1Purchased);
            t1Btn.classList.toggle('disabled-boost', t1Btn.disabled && !rebirthStartT1Purchased);
            
            // 3. Pocket Change T2
            const t2Btn = getButton('rebirth-start-2-btn');
            const t2Cost = 75;
            t2Btn.innerHTML = `Pocket Change T2<br>(Cost: üíé${t2Cost} Shards)`;
            getButton('rebirth-start-2-status').textContent = `Status: ${rebirthStartT2Purchased ? 'PURCHASED' : 'Unpurchased'} (+üí∞10,000 on Rebirth)`;
            t2Btn.disabled = !rebirthStartT1Purchased || rebirthStartT2Purchased || shards < t2Cost;
            t2Btn.classList.toggle('purchased-upgrade', rebirthStartT2Purchased);
            t2Btn.classList.toggle('disabled-boost', t2Btn.disabled && !rebirthStartT2Purchased);
            
            // 4. Sharp Senses
            const rareBtn = getButton('rare-chance-btn');
            const rareCost = 50;
            rareBtn.innerHTML = `Sharp Senses<br>(Cost: üíé${rareCost} Shards)`;
            getButton('rare-chance-status').textContent = `Bonus: +${(rareBonusLuck * 10).toFixed(1)}x (Rare/Uncommon chance)`;
            rareBtn.disabled = rareBonusLuck >= 0.6 || shards < rareCost; // Limit to 3 purchases (0.6x total)
            
            if (rareBonusLuck >= 0.6) {
                 rareBtn.innerHTML = `Sharp Senses (MAXED)<br>(Bonus: 0.6x)`;
                 rareBtn.classList.add('purchased-upgrade');
            } else {
                 rareBtn.classList.remove('purchased-upgrade');
            }
            rareBtn.classList.toggle('disabled-boost', rareBtn.disabled && rareBonusLuck < 0.6);
        }

        
        function buyShardUpgrade(type) {
            let cost, effectFn;
            
            switch(type) {
                case 'shard-mult':
                    cost = 10 * shardMultiplier;
                    effectFn = () => { shardMultiplier += 1; };
                    break;
                case 'rebirth-start-1':
                    cost = 25;
                    if (rebirthStartT1Purchased) return;
                    effectFn = () => { rebirthStartT1Purchased = true; rebirthStartMoney = 2500; };
                    break;
                case 'rebirth-start-2':
                    cost = 75;
                    if (rebirthStartT2Purchased || !rebirthStartT1Purchased) return;
                    effectFn = () => { rebirthStartT2Purchased = true; rebirthStartMoney = 10000; };
                    break;
                case 'rare-chance':
                    cost = 50;
                    if (rareBonusLuck >= 0.6) return; // Max 3 purchases
                    effectFn = () => { rareBonusLuck = Math.min(0.6, rareBonusLuck + 0.2); };
                    break;
                default:
                    return;
            }

            if (shards >= cost) {
                shards -= cost;
                effectFn();
                saveStats();
                updateMoneyDisplay();
            }
        }


        async function openMysteryBox() {
            const COST = 50000;
            if (money < COST) return;
            
            money -= COST;
            saveStats();
            updateMoneyDisplay();

            // 1. Filter for Rare or better Auras
            // Include active LTA if present
            const currentAuraList = getAurasForRolling();
            const highRarityAuras = currentAuraList.filter(a => a.shardValue > 0 || (a.id && activeLimitedAura)); // Use 'id' to identify LTAs

            if (highRarityAuras.length === 0) {
                 // Fallback if no high rarity auras are defined
                 return;
            }
            
            // 2. Roll for the high rarity Aura
            const result = highRarityAuras[Math.floor(Math.random() * highRarityAuras.length)];
            
            // 3. Roll for bonus
            let coinBonus = 0;

            if (Math.random() < 0.10) { // 10% chance for a huge bonus
                coinBonus = 200000;
                money += coinBonus;
                saveStats();
            }

            // 4. Display Result - Will be visible in the main display/inventory
            
            // Add to collection
            saveAuraToCollection(result.name);
            
            // Check Auto-Sell state
            if (isAutoSelling) {
                 const coinGain = Math.floor(result.value * powerMultiplier);
                 money += coinGain;
                 shards += (result.shardValue * shardMultiplier);
                 saveStats();
                 // Display result with note
                 getButton('aura-name').innerText = result.name;
                 getButton('aura-name').className = result.class;
                 getButton('aura-rarity').innerHTML = `MYSTERY BOX! ${result.rarity} Found! (AUTO-SOLD)`;
                 if (coinBonus > 0) {
                      getButton('aura-rarity').innerHTML += `<br> +üí∞${coinBonus.toLocaleString()} BONUS!`;
                 }
            } else {
                 // Add to inventory if not auto-selling
                 addToInventory(result);
                 // Display result normally
                 getButton('aura-name').innerText = result.name;
                 getButton('aura-name').className = result.class;
                 getButton('aura-rarity').innerHTML = `MYSTERY BOX! ${result.rarity} Found!`;
                 if (coinBonus > 0) {
                      getButton('aura-rarity').innerHTML += `<br> +üí∞${coinBonus.toLocaleString()} BONUS!`;
                 }
            }
            updateMoneyDisplay(); 
        }


        // --- SELLING LOGIC UPDATE ---
        function sellAllItems() {
            if (inventory.length === 0) return;

            let totalValue = 0;
            let totalShards = 0;

            inventory.forEach(item => {
                const details = getAuraDetails(item.name);
                if (details) {
                    // Use floor to prevent fractional coin value
                    totalValue += Math.floor(details.value * powerMultiplier); 
                    totalShards += details.shardValue;
                }
            });
            
            // Apply shard multiplier
            const finalShards = totalShards * shardMultiplier;

            // Execute sell instantly
            money += totalValue;
            shards += finalShards;
            inventory = []; 
            saveStats();
            saveInventory();
            updateMoneyDisplay();
            renderInventory(); 
        }
        // --- END SELLING LOGIC UPDATE ---


        // --- LTA ROTATION LOGIC (UPDATED FOR SEASONS) ---
        function determineActiveLimitedAura() {
            const now = new Date();
            const month = now.getMonth(); 
            
            let currentSeason = '';
            let nextSeasonMonth = 0; // Next month when rotation occurs

            if (month >= 2 && month <= 4) { // Mar (2), Apr (3), May (4)
                currentSeason = 'Spring';
                nextSeasonMonth = 5; // June
                activeLimitedAura = null;
            } else if (month >= 5 && month <= 7) { // Jun (5), Jul (6), Aug (7)
                currentSeason = 'Summer';
                nextSeasonMonth = 8; // September
                activeLimitedAura = limitedAuras.find(a => a.season === 'Summer');
            } else if (month >= 8 && month <= 10) { // Sep (8), Oct (9), Nov (10)
                currentSeason = 'Fall';
                nextSeasonMonth = 11; // December
                activeLimitedAura = limitedAuras.find(a => a.season === 'Fall');
            } else { // Dec (11), Jan (0), Feb (1)
                currentSeason = 'Winter';
                nextSeasonMonth = 2; // March
                activeLimitedAura = limitedAuras.find(a => a.season === 'Winter');
            }
            
            // Calculate time until next season
            const nextRotationDate = new Date(now.getFullYear(), nextSeasonMonth, 1);
            if (nextSeasonMonth <= month) {
                 // If the next rotation month is numerically smaller (e.g., Dec to Mar), increment the year
                 nextRotationDate.setFullYear(now.getFullYear() + 1);
            }
            
            const timeUntilRotation = nextRotationDate.getTime() - now.getTime();
            
            const rotationDays = Math.floor(timeUntilRotation / (1000 * 60 * 60 * 24));
            const rotationHours = Math.floor((timeUntilRotation % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const rotationMinutes = Math.floor((timeUntilRotation % (1000 * 60 * 60)) / (1000 * 60));

            const limitedDisplay = getButton('limited-aura-display');
            
            if (activeLimitedAura) {
                 limitedDisplay.innerHTML = `**ACTIVE LTA (${currentSeason}):** <span class="${activeLimitedAura.class}">${activeLimitedAura.name}</span> (${activeLimitedAura.rarity}) <br> *Time Remaining: ${rotationDays}d ${rotationHours}h ${rotationMinutes}m*`;
            } else {
                 limitedDisplay.innerHTML = `**NO ACTIVE LTA (${currentSeason}).** <br> *Next LTA activates on the first day of ${getMonthName(nextSeasonMonth)}!*`;
            }
        }
        
        function getMonthName(monthIndex) {
            const date = new Date(2000, monthIndex, 1);
            return date.toLocaleString('default', { month: 'long' });
        }


        function getAurasForRolling() {
            // Only include the activeLimitedAura if it is actually set
            return activeLimitedAura ? [...auras, activeLimitedAura] : auras;
        }
        // --- END LTA ROTATION LOGIC ---
        
        // --- GENERAL GAME FUNCTIONS (Tab control, Rebirth, Speed Shop, Rolling) ---

        function openTab(tabName, elmnt) {
            const tabcontent = document.getElementById(tabName);
            const manualBtn = getButton('roll-btn');
            
            if (elmnt.classList.contains('active')) {
                elmnt.classList.remove('active');
                tabcontent.classList.remove('active');
                activeTabName = null;
                
                // Only re-enable if Auto-Roll is off
                if (!autoRollInterval) { 
                     manualBtn.disabled = false;
                     manualBtn.innerText = "STEAL!";
                }

            } else {
                const allTabContents = document.getElementsByClassName("tab-content");
                for (let i = 0; i < allTabContents.length; i++) {
                    allTabContents[i].classList.remove('active');
                }

                const allTablinks = document.getElementsByClassName("tab-button");
                for (let i = 0; i < allTablinks.length; i++) {
                    allTablinks[i].classList.remove('active');
                }

                tabcontent.classList.add('active');
                elmnt.classList.add('active');
                activeTabName = tabName;
                
                 if (autoRollInterval) {
                     manualBtn.disabled = true;
                     manualBtn.innerText = "STEAL!"; 
                }
            }
        }

        function calculatePowerMultiplier() {
            powerMultiplier = Math.pow(POWER_BONUS, power);
        }

        function updatePowerDisplay() {
            getButton('power-display').textContent = power.toLocaleString();
            updateRebirthDisplay();
        }
        
        function loadSpeed() {
            const storedSpeed = localStorage.getItem(SPEED_STORAGE_KEY);
            if (storedSpeed !== null) {
                autoRollSpeed = parseInt(storedSpeed);
                
                let currentLevel = 0;
                speedUpgrades.forEach(upgrade => {
                    if (upgrade.speed === autoRollSpeed) {
                        currentLevel = upgrade.id;
                    }
                });
                speedLevel = currentLevel;
            }
        }
        
        function loadCollection() {
            const storedCollection = localStorage.getItem(COLLECTION_STORAGE_KEY);
            if (storedCollection) {
                try {
                    const parsed = JSON.parse(storedCollection);
                    collectedAuras = new Set(parsed);
                } catch (e) {
                    collectedAuras = new Set();
                }
            }
        }

        function saveCollection() {
            localStorage.setItem(COLLECTION_STORAGE_KEY, JSON.stringify(Array.from(collectedAuras)));
        }

        function saveAuraToCollection(auraName) {
            if (!collectedAuras.has(auraName)) {
                collectedAuras.add(auraName);
                saveCollection();
                renderChecklist();
                updateCollectedCount();
            }
        }

        function renderChecklist() {
            const listEl = getButton('uncollected-list');
            listEl.innerHTML = '';

            const allAurasForChecklist = [...auras, ...limitedAuras].sort((a, b) => b.chance - a.chance);

            allAurasForChecklist.forEach(aura => {
                const div = document.createElement('div');
                div.className = "uncollected-item";

                if (collectedAuras.has(aura.name)) {
                    div.classList.add('collected-item');
                }

                div.innerHTML = `<span class="${aura.class}">${aura.name}</span><br>${aura.rarity}`;
                listEl.appendChild(div);
            });
        }

        function renderInventory() {
             const list = getButton('inventory-list');
             list.innerHTML = '';
             const allAuras = [...auras, ...limitedAuras];

             inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = "inv-item";

                const fullAura = allAuras.find(a => a.name === item.name);
                const itemClass = fullAura ? fullAura.class : '';
                const itemRarity = fullAura ? fullAura.rarity : 'Unknown';

                div.innerHTML = `<strong class="${itemClass}">${item.name}</strong><br>${itemRarity}`;
                list.appendChild(div);
            });

            const sellBtn = getButton('sell-all-btn');
            sellBtn.textContent = `SELL ALL ITEMS (${inventory.length})`;
        }

        function getRebirthCost() {
            return BASE_REBIRTH_COST * Math.pow(POWER_BONUS, power);
        }

        function updateRebirthDisplay() {
            const costDisplay = getButton('rebirth-cost-display');
            const rebirthBtn = getButton('rebirth-btn');
            const cost = getRebirthCost();
            
            getButton('income-mult-display').textContent = `${powerMultiplier.toFixed(1)}x`;

            if (money >= cost) {
                costDisplay.innerHTML = `You can afford the Rebirth! Get ‚ö° ${power + 1} for a total of ‚ö°${power + 1} Power.`;
                rebirthBtn.disabled = false;
                rebirthBtn.textContent = `REBIRTH NOW (Cost: üí∞${cost.toLocaleString()})`;
            } else {
                costDisplay.innerHTML = `Next Rebirth Cost: üí∞${cost.toLocaleString()} (Need üí∞${(cost - money).toLocaleString()} more)`;
                rebirthBtn.disabled = true;
                rebirthBtn.textContent = `REBIRTH NOW`;
            }
        }
        
        function doRebirth() {
            if (money < getRebirthCost()) return;
            
            if (confirm(`Are you sure you want to Rebirth? This will reset your coins, speed upgrades, inventory, and luck boosts, but you will gain 1 Power and permanently multiply your income by ${(powerMultiplier * POWER_BONUS).toFixed(1)}x!`)) {
                
                power += 1;
                calculatePowerMultiplier();
                savePower();
                
                // Reset resources, but use the permanent start money upgrade
                money = rebirthStartMoney; 
                shards = 0;
                shardMultiplier = 1; 
                autoRollSpeed = 1000;
                speedLevel = 0;
                inventory = [];
                isAutoSelling = false; // Reset auto sell on rebirth
                luckMultiplier = 1; // Reset luck state
                rollsLeft = 0;
                // Stop all timers
                Object.values(cooldownTimers).forEach(clearInterval);
                cooldownTimers = {};
                boostButtons.forEach(b => cooldowns[b.id] = 0);
                
                saveStats(); 
                saveSpeed();
                saveInventory();
                saveBoostState(); 
                
                updateMoneyDisplay();
                updatePowerDisplay();
                renderSpeedShop();
            }
        }

        function resetGame() {
            if (confirm("üö® WARNING: Are you absolutely sure you want to clear ALL game data (Money, Shards, Power, Collection, Boosts)? This action is irreversible!")) {
                localStorage.clear();
                window.location.reload();
            }
        }

        function renderSpeedShop() {
            const shopEl = getButton('speed-upgrades');
            shopEl.innerHTML = '';
            getButton('speed-level-display').textContent = `(Level ${speedLevel}. Current: ${autoRollSpeed}ms)`;

            speedUpgrades.forEach(upgrade => {
                const btn = document.createElement('button');
                btn.className = 'upgrade-btn';
                
                const isPurchased = upgrade.id <= speedLevel;

                if (isPurchased) {
                    btn.textContent = `${upgrade.label} - PURCHASED`;
                    btn.disabled = true;
                    btn.classList.add('purchased-upgrade');
                } else {
                    btn.textContent = `${upgrade.label} - Cost: üí∞${upgrade.cost.toLocaleString()}`;
                    btn.onclick = () => buySpeedUpgrade(upgrade);
                    
                    if (money < upgrade.cost || upgrade.id !== speedLevel + 1) {
                        btn.disabled = true;
                    }
                }
                shopEl.appendChild(btn);
            });
        }

        function buySpeedUpgrade(upgrade) {
            if (money >= upgrade.cost && upgrade.id === speedLevel + 1) {
                money -= upgrade.cost;
                
                speedLevel = upgrade.id;
                autoRollSpeed = upgrade.speed;

                saveStats();
                saveSpeed(); 
                updateMoneyDisplay(); 
                
                if (autoRollInterval) {
                    toggleAutoRoll(); 
                    toggleAutoRoll();
                }
            }
        }

        const formatTime = (totalSeconds) => {
            if (totalSeconds < 60) return `${totalSeconds}s`;
            if (totalSeconds < 3600) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
            }
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours}h ${minutes}m ${seconds.toString().padStart(2, '0')}s`;
        };

        function updateBoostButtonDisplay(id, name, cost, timeRemaining = 0, currentMultiplier) {
            const btn = getButton(id);
            if (!btn) return;

            const boost = boostButtons.find(b => b.id === id); // Find by ID

            if (currentMultiplier === boost.mult && rollsLeft > 0) {
                btn.disabled = true;
                btn.innerHTML = `BOOST ACTIVE<br>(${rollsLeft} Rolls)`;
                btn.classList.add('active-boost');
                btn.classList.remove('disabled-boost');
            }
            else if (timeRemaining > 0) {
                btn.disabled = true;
                btn.innerHTML = `COOLDOWN<br>(${formatTime(timeRemaining)})`;
                btn.classList.add('disabled-boost');
                btn.classList.remove('active-boost');
            }
            else if (money < boost.cost) {
                btn.disabled = true;
                btn.innerHTML = `${name}<br>(Cost: üí∞${boost.cost.toLocaleString()}) <span style="color:red;">(TOO POOR)</span>`;
                btn.classList.add('disabled-boost');
                btn.classList.remove('active-boost');
            }
            else {
                btn.disabled = false;
                btn.innerHTML = `${name}<br>(Cost: üí∞${boost.cost.toLocaleString()})`;
                btn.classList.remove('disabled-boost');
                btn.classList.remove('active-boost');
            }
        }

        function updateLuckDisplay() {
            const luckDisplayEl = getButton('luck-display');

            if (luckMultiplier > 1) {
                luckDisplayEl.textContent = `${luckMultiplier}x (${rollsLeft} rolls left)`;
                luckDisplayEl.className = 'luck-boost';
                if (luckMultiplier === 10) luckDisplayEl.classList.add('x10-boost');
                else if (luckMultiplier === 100) luckDisplayEl.classList.add('x100-boost');
            } else {
                luckDisplayEl.textContent = '1x';
                luckDisplayEl.className = 'luck-boost';
            }

            boostButtons.forEach(b => {
                updateBoostButtonDisplay(b.id, b.name, b.cost, cooldowns[b.id], luckMultiplier);
            });
        }

        function startCooldown(boostId, cooldownTime) {
            // Clear any existing timer for this boost
            if (cooldownTimers[boostId]) {
                clearInterval(cooldownTimers[boostId]);
            }

            cooldowns[boostId] = cooldownTime;

            const timer = setInterval(() => {
                cooldowns[boostId]--;
                saveBoostState(); 
                
                const boostDetails = boostButtons.find(b => b.id === boostId);
                // Only update the display if this boost isn't the active one (which is handled by updateLuckDisplay)
                if (luckMultiplier !== boostDetails.mult) {
                    updateBoostButtonDisplay(boostId, boostDetails.name, boostDetails.cost, cooldowns[boostId], luckMultiplier);
                }

                if (cooldowns[boostId] <= 0) {
                    clearInterval(timer);
                    delete cooldownTimers[boostId];
                    cooldowns[boostId] = 0;
                    saveBoostState(); 
                    updateLuckDisplay(); 
                }
            }, 1000);

            cooldownTimers[boostId] = timer;
        }

        function activateBoost(multiplier) {
            const boost = boostButtons.find(b => b.mult === multiplier);

            if (luckMultiplier > 1 || cooldowns[boost.id] > 0) return;
            if (money < boost.cost) return;

            money -= boost.cost;
            saveStats();
            updateMoneyDisplay(); 

            luckMultiplier = multiplier;
            rollsLeft = boost.rolls;

            startCooldown(boost.id, boost.duration);
            saveBoostState(); 
        }

        async function rollAura(isAuto) {
            // FIX: If the button is already disabled because a roll is processing, exit.
            // This prevents duplicate execution when the user rapid-clicks.
            if (isRolling) return;
            isRolling = true;

            const btn = getButton('roll-btn');

            if (!isAuto) { 
                btn.disabled = true;
                btn.innerText = "STEALING...";
            }


            const nameEl = getButton('aura-name');
            const rarityEl = getButton('aura-rarity');
            let ticks = 0;
            let maxTicks = 10;
            const rollMoney = 10; 

            money += Math.floor(rollMoney * powerMultiplier);
            saveStats();
            updateMoneyDisplay();

            const auraList = getAurasForRolling();

            // Only run the visible animation if on a tab that allows it (or no tab is active)
            // AND if it's not an auto-roll.
            if (!isAuto && (activeTabName === 'luck-shop' || activeTabName === 'loot-shop' || activeTabName === 'speed-shop' || activeTabName === 'power-shop' || activeTabName === null)) {
                await new Promise(resolve => {
                    let interval = setInterval(() => {
                        let randomTemp = auraList[Math.floor(Math.random() * auraList.length)];
                        nameEl.innerText = randomTemp.name;
                        nameEl.className = "";
                        rarityEl.innerText = "...";
                        ticks++;

                        if (ticks >= maxTicks) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 100);
                });
            } else {
                 // For auto-roll or hidden tabs, run a quick hidden delay
                 await new Promise(resolve => setTimeout(resolve, isAuto ? 10 : 100));
            }

            finalizeRoll();

            isRolling = false;
            
            // FIX: Ensure the manual roll button is re-enabled if auto-roll is not active.
            if (!autoRollInterval) {
                btn.disabled = false;
                btn.innerText = "STEAL AGAIN";
            } else {
                btn.disabled = true; 
                btn.innerText = "STEAL!";
            }


            if (luckMultiplier > 1) {
                rollsLeft--;
                if (rollsLeft <= 0) {
                    luckMultiplier = 1;
                    rollsLeft = 0;
                    // Force a save and display update immediately when boost ends
                    saveBoostState(); 
                    updateLuckDisplay();
                } else {
                    saveBoostState(); 
                    updateLuckDisplay();
                }
            }
            
            // Periodically save general stats during auto-roll
             if (autoRollInterval && Math.random() < 0.05) { 
                 saveStats();
                 saveInventory();
            }
        }

        function finalizeRoll() {
            let result = null;
            const currentAuraList = getAurasForRolling();

            const sortedAuras = [...currentAuraList].sort((a, b) => b.chance - a.chance);

            for (let aura of sortedAuras) {
                let threshold = (1000 / aura.chance) * luckMultiplier;
                
                if (aura.rarity === 'Uncommon' || aura.rarity === 'Rare') {
                    threshold += threshold * rareBonusLuck; 
                }

                if (Math.random() * 1000 <= threshold) {
                    result = aura;
                    break;
                }
            }

            // Ensure a result is always found (defaults to the first Common if all else fails)
            if (!result) result = auras[0];

            const coinGain = Math.floor(result.value * powerMultiplier);
            const shardGain = result.shardValue * shardMultiplier;
            
            // --- AUTO-SELL CHECK ---
            if (isAutoSelling) {
                money += coinGain;
                shards += shardGain;
                
                // FIX: Make sure the display updates for auto-sold items even if on a game-relevant tab.
                if (activeTabName === 'luck-shop' || activeTabName === 'loot-shop' || activeTabName === 'speed-shop' || activeTabName === 'power-shop' || activeTabName === null) {
                    displayResult(result, coinGain, true); // Pass 'true' for auto-sold
                }
            } else {
                money += coinGain;
                
                 if (activeTabName === 'luck-shop' || activeTabName === 'loot-shop' || activeTabName === 'speed-shop' || activeTabName === 'power-shop' || activeTabName === null) {
                    displayResult(result, coinGain, false);
                }
                addToInventory(result);
            }
            // --- END AUTO-SELL CHECK ---

            saveAuraToCollection(result.name);
            updateMoneyDisplay(); 
            
        }

        function displayResult(item, coinGain, wasAutoSold) {
            const nameEl = getButton('aura-name');
            const rarityEl = getButton('aura-rarity');

            nameEl.innerText = item.name;
            nameEl.className = item.class;
            
            let rarityText = `1 in ${item.chance} ‚Ä¢ ${item.rarity}<br>+üí∞${coinGain.toLocaleString()} from steal`;
            
            if (wasAutoSold) {
                // If auto-sold, show shard gain too
                rarityText += ` +üíé${item.shardValue * shardMultiplier} (AUTO-SOLD)`;
            } else {
                rarityText += ` (Saved to Inventory)`;
            }

            rarityEl.innerHTML = rarityText;

            if (item.chance >= 50) {
                document.body.classList.add("flash");
                setTimeout(() => document.body.classList.remove("flash"), 500);
            }
        }

        function addToInventory(item) {
            inventory.unshift({
                name: item.name,
                value: item.value 
            });

            if (inventory.length > 500) {
                 inventory.pop();
            }

            renderInventory(); 
            saveInventory(); 
        }

        function toggleAutoRoll() {
            const autoBtn = getButton('auto-roll-btn');
            const manualBtn = getButton('roll-btn');
            
            const throttleElement = getButton('throttle-preventer'); 

            if (autoRollInterval) {
                // --- STOP AUTO ROLL ---
                clearInterval(autoRollInterval);
                autoRollInterval = null;
                autoBtn.innerText = "AUTO ROLL";
                // Only re-enable manual button if we are NOT viewing a non-rolling tab
                if (activeTabName === 'luck-shop' || activeTabName === 'loot-shop' || activeTabName === 'speed-shop' || activeTabName === 'power-shop' || activeTabName === null) {
                    manualBtn.disabled = false;
                    manualBtn.innerText = "STEAL AGAIN";
                }
                
                if (throttleElement) { throttleElement.pause(); throttleElement.currentTime = 0; }
                
                saveStats(); 
                saveInventory();


            } else {
                // --- START AUTO ROLL ---
                manualBtn.disabled = true;
                manualBtn.innerText = "STEAL!";
                autoBtn.innerText = "STOP AUTO ROLL";

                if (throttleElement) throttleElement.play().catch(e => console.error("Audio Autoplay prevented. Background rolling may fail.", e));

                autoRollInterval = setInterval(() => {
                    rollAura(true);
                }, autoRollSpeed);
            }
        }
    </script>

</body>

</html>
